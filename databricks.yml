# Industry Solutions Blueprint style: single bundle file, jobs + dashboards inline
bundle:
  name: fraud-data-pipeline

variables:
  project_name:
    description: "Name of your solution accelerator"
    default: "telecom-fraud-data-pipeline"
  warehouse_id:
    lookup:
      warehouse: "Shared Endpoint"
  environment:
    description: "Deployment environment (dev, staging, prod)"
    default: "dev"
  catalog:
    description: "Unity Catalog name"
    default: "telecommunications"
  schema:
    description: "Schema name for fraud detection tables"
    default: "fraud_data"

targets:
  dev:
    default: true
    mode: development
    workspace:
      profile: e2-demo-west
    variables:
      catalog: "telecommunications"
      schema: "fraud_data"

  prod:
    mode: production
    workspace:
      profile: e2-demo-west
    variables:
      catalog: "telecommunications"
      schema: "fraud_data"

resources:
  volumes:
    raw_app_transactions:
      catalog_name: ${var.catalog}
      schema_name: ${var.schema}
      name: "raw_app_transactions"
      volume_type: "MANAGED"

    raw_device_sdk:
      catalog_name: ${var.catalog}
      schema_name: ${var.schema}
      name: "raw_device_sdk"
      volume_type: "MANAGED"

    raw_network_data:
      catalog_name: ${var.catalog}
      schema_name: ${var.schema}
      name: "raw_network_data"
      volume_type: "MANAGED"

  jobs:
    fraud_data_pipeline:
      name: "[${bundle.target}] Fraud Data Pipeline"
      parameters:
        - name: catalog
          default: "${var.catalog}"
        - name: schema
          default: "${var.schema}"
      tasks:
        - task_key: Device_ID_Reference
          spark_python_task:
            python_file: ./notebooks/generate_device_id_reference.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
          environment_key: fraud_data_pipeline_environment

        - task_key: Cell_Registry
          depends_on:
            - task_key: Device_ID_Reference
          spark_python_task:
            python_file: ./notebooks/generate_cell_registry.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
          environment_key: fraud_data_pipeline_environment

        - task_key: Raw_Device_SDK
          depends_on:
            - task_key: Device_ID_Reference
          spark_python_task:
            python_file: ./notebooks/generate_raw_device_sdk.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
          environment_key: fraud_data_pipeline_environment

        - task_key: Bronze_Device_SDK
          depends_on:
            - task_key: Raw_Device_SDK
          spark_python_task:
            python_file: ./notebooks/generate_bronze_device_sdk.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
              - "--source"
              - "volume"
          environment_key: fraud_data_pipeline_environment

        - task_key: Raw_App_Transactions
          depends_on:
            - task_key: Device_ID_Reference
          spark_python_task:
            python_file: ./notebooks/generate_raw_app_transactions.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
          environment_key: fraud_data_pipeline_environment

        - task_key: Bronze_Transactions
          depends_on:
            - task_key: Raw_App_Transactions
          spark_python_task:
            python_file: ./notebooks/generate_bronze_app_transactions.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
              - "--source"
              - "volume"
          environment_key: fraud_data_pipeline_environment

        - task_key: Silver_Device_SDK
          depends_on:
            - task_key: Bronze_Device_SDK
          spark_python_task:
            python_file: ./notebooks/generate_silver_device_sdk.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
          environment_key: fraud_data_pipeline_environment

        - task_key: Gold_Device_SDK
          depends_on:
            - task_key: Silver_Device_SDK
          spark_python_task:
            python_file: ./notebooks/generate_gold_device_sdk.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
          environment_key: fraud_data_pipeline_environment

        - task_key: Silver_Transactions
          depends_on:
            - task_key: Bronze_Transactions
          spark_python_task:
            python_file: ./notebooks/generate_silver_app_transactions.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
          environment_key: fraud_data_pipeline_environment

        - task_key: Gold_Transactions
          depends_on:
            - task_key: Silver_Transactions
          spark_python_task:
            python_file: ./notebooks/generate_gold_app_transactions.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
          environment_key: fraud_data_pipeline_environment

        - task_key: Risk_Engine
          depends_on:
            - task_key: Gold_Transactions
            - task_key: Gold_Device_SDK
          spark_python_task:
            python_file: ./notebooks/risk_engine.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
          environment_key: fraud_data_pipeline_environment

        - task_key: Raw_Network_Data
          depends_on:
            - task_key: Cell_Registry
          spark_python_task:
            python_file: ./notebooks/generate_raw_network_data.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
          environment_key: fraud_data_pipeline_environment

        - task_key: Bronze_Network_Data
          depends_on:
            - task_key: Raw_Network_Data
          spark_python_task:
            python_file: ./notebooks/generate_bronze_network_data.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
              - "--source"
              - "volume"
          environment_key: fraud_data_pipeline_environment

        - task_key: Silver_Network_Data
          depends_on:
            - task_key: Bronze_Network_Data
          spark_python_task:
            python_file: ./notebooks/generate_silver_network_data.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
          environment_key: fraud_data_pipeline_environment

        - task_key: Gold_Network_Data
          depends_on:
            - task_key: Silver_Network_Data
          spark_python_task:
            python_file: ./notebooks/generate_gold_network_data.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
          environment_key: fraud_data_pipeline_environment

        - task_key: analyst_simulation
          depends_on:
            - task_key: Risk_Engine
          spark_python_task:
            python_file: ./notebooks/run_analyst_simulation.py
            parameters:
              - "--catalog"
              - "{{job.parameters.catalog}}"
              - "--schema"
              - "{{job.parameters.schema}}"
          environment_key: fraud_data_pipeline_environment

      queue:
        enabled: true

      environments:
        - environment_key: Default
          spec:
            client: "1"
        - environment_key: fraud_data_pipeline_environment
          spec:
            dependencies:
              - "pandas>=1.5.0"
              - "numpy>=1.21.0"
              - "scikit-learn>=1.1.0"
              - "matplotlib>=3.5.0"
              - "seaborn>=0.11.0"
              - "hdbscan>=0.8.0"
              - "faker>=18.0.0"
            client: "1"

      permissions:
        - level: CAN_VIEW
          group_name: "users"
        - level: CAN_MANAGE_RUN
          group_name: "users"

  dashboards:
    fraud_detection:
      display_name: "Fraud Detection"
      file_path: "./dashboards/fraud_detection.lvdash.json"
      warehouse_id: "${var.warehouse_id}"
